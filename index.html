<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=800, initial-scale=0.5, maximum-scale=2.0, user-scalable=yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Meu$">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#593825">
  <title>Meu$</title>
  <link rel="manifest" href="/manifest.webmanifest">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    :root{--primary:#593825;--primary-dark:#3D2518;--secondary:#9D9167;--background:#FAF9F7;--card-bg:#FFFFFF;--success:#4A9B6E;--success-light:#E8F5ED;--danger:#C45C4D;--danger-light:#FDEAE8;--warning:#E8A940;--text-dark:#1A1A1A;--text-medium:#666;--text-light:#999;--border:#F0EEEB;--safe-top:env(safe-area-inset-top);--safe-bottom:env(safe-area-inset-bottom)}
    [data-theme="dark"]{--primary:#6B4332;--primary-dark:#4A2E22;--secondary:#B8A87A;--background:#1A1A1A;--card-bg:#2D2D2D;--success:#5AB87A;--success-light:#1E3A2A;--danger:#E07060;--danger-light:#3A1E1E;--warning:#F0B850;--text-dark:#F0F0F0;--text-medium:#B0B0B0;--text-light:#808080;--border:#404040}
    html{height:100%}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--background);color:var(--text-dark);font-size:16px;min-height:100%;display:flex;flex-direction:column;min-width:800px}
    
    .splash{position:fixed;inset:0;background:linear-gradient(145deg,#593825,#3D2518);display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:10000;opacity:1;transition:opacity .3s}
    .splash.hide{opacity:0;pointer-events:none}
    .splash-logo{font-size:100px;margin-bottom:20px}
    .splash-title{color:#fff;font-size:42px;font-weight:700}
    .splash-sub{color:rgba(255,255,255,.6);font-size:20px;margin-top:8px}
    .splash-spin{width:50px;height:50px;border:5px solid rgba(255,255,255,.2);border-top-color:#fff;border-radius:50%;animation:spin .7s linear infinite;margin-top:40px}
    @keyframes spin{to{transform:rotate(360deg)}}
    
    .app{display:flex;flex-direction:column;min-height:100vh;padding-top:var(--safe-top)}
    .header{background:var(--primary);padding:18px 24px;display:flex;justify-content:space-between;align-items:center;flex-shrink:0;position:sticky;top:0;z-index:100}
    [data-theme="dark"] .header{background:var(--card-bg);border-bottom:1px solid var(--border)}
    .logo{display:flex;align-items:center;gap:14px;color:#fff;font-size:28px;font-weight:700}
    [data-theme="dark"] .logo{color:var(--text-dark)}
    .header-right{display:flex;align-items:center;gap:16px}
    .month-sel{background:rgba(255,255,255,.15);border:none;border-radius:12px;padding:14px 20px;color:#fff;font-size:18px;font-weight:500}
    .month-sel option{background:var(--card-bg);color:var(--text-dark)}
    [data-theme="dark"] .month-sel{background:var(--border);color:var(--text-dark)}
    .theme-btn{background:rgba(255,255,255,.15);border:none;border-radius:50%;width:52px;height:52px;font-size:28px;cursor:pointer}
    [data-theme="dark"] .theme-btn{background:var(--border)}
    
    .main{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;padding-bottom:90px}
    .container{padding:20px 24px;max-width:100%;margin:0 auto}
    
    .alert{background:var(--danger-light);border-left:5px solid var(--danger);padding:16px 20px;margin:0 24px 16px;border-radius:0 12px 12px 0;display:none;align-items:center;gap:14px}
    .alert.show{display:flex}
    .alert-text{flex:1}
    .alert-title{font-size:17px;font-weight:600;color:var(--danger)}
    .alert-detail{font-size:15px;color:var(--danger);opacity:.8}
    
    /* RESUMO */
    .resumo-section{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;margin-bottom:20px;align-items:stretch}
    .resumo-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .card{background:var(--card-bg);border-radius:16px;padding:18px;box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .card-label{font-size:13px;font-weight:600;color:var(--text-light);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}
    .card-value{font-size:26px;font-weight:700}
    .card-value.green{color:var(--success)}
    .card-value.red{color:var(--danger)}
    .reserva-box{background:var(--card-bg);border-radius:16px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,.06);border-left:6px solid var(--success);display:flex;flex-direction:column;justify-content:center}
    .reserva-head{display:flex;align-items:center;gap:10px;margin-bottom:8px}
    .reserva-icon{font-size:28px}
    .reserva-title{font-size:14px;font-weight:600;color:var(--success);text-transform:uppercase}
    .reserva-val{font-size:34px;font-weight:700;color:var(--success)}
    .reserva-sub{font-size:13px;color:var(--text-light);margin-top:4px}
    
    /* OBJETIVOS - 4 colunas */
    .obj-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:20px}
    .obj-card{background:var(--card-bg);border-radius:14px;padding:16px 12px;box-shadow:0 2px 8px rgba(0,0,0,.06);text-align:center;position:relative;min-height:120px}
    .obj-chart{position:relative;width:70px;height:70px;margin:0 auto 10px}
    .obj-val{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:14px;font-weight:700;color:var(--success)}
    .obj-name{font-size:14px;font-weight:600;color:var(--text-dark);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;padding:0 6px}
    .obj-del{position:absolute;top:6px;right:6px;background:var(--danger);color:#fff;border:none;border-radius:50%;width:26px;height:26px;font-size:16px;cursor:pointer;display:none;align-items:center;justify-content:center;line-height:1}
    .obj-card:hover .obj-del,.obj-card:active .obj-del{display:flex}
    
    /* GR√ÅFICOS - 2 colunas */
    .chart-box{background:var(--card-bg);border-radius:16px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,.06);margin-bottom:18px}
    .chart-title{font-size:18px;font-weight:600;margin-bottom:14px;display:flex;align-items:center;gap:10px}
    .chart-wrap{height:220px;position:relative}
    .charts-2col{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:18px}
    .charts-2col .chart-box{margin-bottom:0}
    .charts-2col .chart-wrap{height:200px}
    
    /* CART√ïES - 4 colunas */
    .cartoes-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:20px}
    .cartao-box{background:var(--card-bg);border-radius:14px;padding:16px 12px;box-shadow:0 2px 8px rgba(0,0,0,.06);text-align:center;position:relative;min-height:130px}
    .cartao-icon{width:44px;height:44px;border-radius:10px;margin:0 auto 8px;display:flex;align-items:center;justify-content:center;font-size:20px}
    .cartao-icon.nubank{background:linear-gradient(145deg,#8A05BE,#6B04A0)}
    .cartao-icon.inter{background:linear-gradient(145deg,#FF7A00,#E06800)}
    .cartao-icon.itau{background:linear-gradient(145deg,#003399,#002277)}
    .cartao-icon.bradesco{background:linear-gradient(145deg,#CC092F,#A00725)}
    .cartao-icon.santander{background:linear-gradient(145deg,#EC0000,#CC0000)}
    .cartao-icon.c6{background:linear-gradient(145deg,#1A1A1A,#000)}
    .cartao-icon.default{background:linear-gradient(145deg,var(--primary),var(--primary-dark))}
    .cartao-nome{font-size:15px;font-weight:600;margin-bottom:4px}
    .cartao-fat{font-size:18px;color:var(--danger);font-weight:700}
    .cartao-disp{font-size:13px;color:var(--success);margin-top:6px;padding-top:6px;border-top:1px solid var(--border)}
    .cartao-del{position:absolute;top:6px;right:6px;background:var(--danger);color:#fff;border:none;border-radius:50%;width:26px;height:26px;font-size:16px;cursor:pointer;display:none;align-items:center;justify-content:center;line-height:1}
    .cartao-box:hover .cartao-del,.cartao-box:active .cartao-del{display:flex}
    
    /* NAV */
    .nav{background:var(--card-bg);border-top:1px solid var(--border);display:flex;justify-content:space-around;padding:14px 0;position:fixed;bottom:0;left:0;right:0;z-index:1000;padding-bottom:calc(14px + var(--safe-bottom))}
    .nav-btn{display:flex;flex-direction:column;align-items:center;gap:6px;border:none;background:none;color:var(--text-light);font-size:15px;font-weight:500;padding:12px 30px;cursor:pointer}
    .nav-btn.active{color:var(--primary)}
    .nav-btn .ico{font-size:32px}
    
    .tab{display:none}
    .tab.active{display:block}
    
    /* FORMUL√ÅRIOS - 4 colunas + 1 extra */
    .add-wrap{display:grid;grid-template-columns:1.2fr 1fr 1fr 1fr;gap:16px}
    .form-box{background:var(--card-bg);border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,.06);overflow:hidden}
    .form-head{padding:16px 18px;display:flex;align-items:center;gap:12px;cursor:pointer;border-bottom:1px solid var(--border)}
    .form-head-icon{font-size:24px}
    .form-head-title{flex:1;font-size:17px;font-weight:600}
    .form-head-badge{font-size:14px;color:var(--text-light);background:var(--background);padding:5px 12px;border-radius:14px}
    .form-head-arrow{font-size:14px;color:var(--text-light);transition:transform .2s}
    .form-box.closed .form-head-arrow{transform:rotate(-90deg)}
    .form-box.closed .form-body{display:none}
    .form-body{padding:18px}
    .form-group{margin-bottom:16px}
    .form-label{display:block;font-size:15px;font-weight:500;color:var(--text-medium);margin-bottom:8px}
    .form-input,.form-select{width:100%;padding:14px;border:1px solid var(--border);border-radius:12px;font-size:17px;background:var(--card-bg);color:var(--text-dark)}
    .form-input:focus,.form-select:focus{outline:none;border-color:var(--primary)}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .btn{width:100%;padding:16px;border:none;border-radius:12px;font-size:18px;font-weight:600;cursor:pointer;background:var(--primary);color:#fff}
    .btn:disabled{background:var(--text-light)}
    .btn-spin{display:inline-block;width:20px;height:20px;border:3px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .6s linear infinite;margin-right:10px}
    .credit-fields{display:none;margin-top:16px;padding-top:16px;border-top:1px dashed var(--border)}
    .credit-fields.show{display:block}
    
    .conta-item{display:flex;align-items:center;gap:12px;padding:14px;background:var(--background);border-radius:12px;margin-bottom:10px}
    .conta-item.pago{opacity:.5}
    .conta-check{width:26px;height:26px;accent-color:var(--success)}
    .conta-info{flex:1}
    .conta-nome{font-size:16px;font-weight:500}
    .conta-item.pago .conta-nome{text-decoration:line-through}
    .conta-detalhe{font-size:14px;color:var(--text-light)}
    .conta-valor{font-size:18px;font-weight:600;color:var(--danger)}
    .conta-del{background:none;border:none;font-size:20px;opacity:.4;cursor:pointer;padding:8px}
    
    .hist-list{display:flex;flex-direction:column;gap:12px}
    .hist-item{display:flex;align-items:center;gap:16px;padding:18px;background:var(--card-bg);border-radius:14px;box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .hist-icon{width:56px;height:56px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:26px;flex-shrink:0}
    .hist-icon.in{background:var(--success-light)}
    .hist-icon.out{background:var(--danger-light)}
    .hist-info{flex:1;min-width:0}
    .hist-desc{font-size:18px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .hist-meta{font-size:15px;color:var(--text-light);margin-top:4px}
    .hist-right{text-align:right}
    .hist-val{font-size:20px;font-weight:600}
    .hist-val.in{color:var(--success)}
    .hist-val.out{color:var(--danger)}
    .hist-del{background:none;border:none;font-size:20px;opacity:.4;cursor:pointer;padding:8px;margin-top:8px}
    .parc-badge{display:inline-block;background:var(--secondary);color:#fff;padding:4px 8px;border-radius:6px;font-size:13px;margin-left:8px}
    
    .toast-wrap{position:fixed;top:calc(80px + var(--safe-top));left:24px;right:24px;z-index:9000;pointer-events:none}
    .toast{background:var(--text-dark);color:#fff;padding:16px 20px;border-radius:12px;margin-bottom:10px;font-size:17px;font-weight:500;animation:fadeIn .3s}
    .toast.ok{background:var(--success)}
    .toast.err{background:var(--danger)}
    @keyframes fadeIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
    
    .empty{text-align:center;padding:30px;color:var(--text-light)}
    .empty-icon{font-size:44px;margin-bottom:10px;opacity:.5}
    .empty p{font-size:16px}
    .section-title{font-size:18px;font-weight:600;color:var(--text-medium);margin-bottom:16px;display:flex;align-items:center;gap:10px}
  </style>
</head>
<body>
  <div class="splash" id="splash">
    <div class="splash-logo">üí∞</div>
    <div class="splash-title">Meu$</div>
    <div class="splash-sub">Controle Financeiro</div>
    <div class="splash-spin"></div>
  </div>
  
  <div class="app">
    <header class="header">
      <div class="logo"><span>üí∞</span><span>Meu$</span></div>
      <div class="header-right">
        <select class="month-sel" id="monthFilter" onchange="filtrarMes()"><option value="atual">M√™s Atual</option></select>
        <button class="theme-btn" onclick="toggleTheme()" id="themeBtn">üåô</button>
      </div>
    </header>
    
    <div class="toast-wrap" id="toastWrap"></div>
    
    <main class="main">
      <div class="alert" id="alertBox">
        <span>‚ö†Ô∏è</span>
        <div class="alert-text">
          <div class="alert-title" id="alertTitle"></div>
          <div class="alert-detail" id="alertDetail"></div>
        </div>
      </div>
      
      <section class="tab active" id="tab-home">
        <div class="container">
          <div class="resumo-section">
            <div class="resumo-grid">
              <div class="card"><div class="card-label">Entradas</div><div class="card-value green" id="vEntradas">R$ 0,00</div></div>
              <div class="card"><div class="card-label">Sa√≠das</div><div class="card-value red" id="vSaidas">R$ 0,00</div></div>
              <div class="card"><div class="card-label">Patrim√¥nio</div><div class="card-value" id="vPatrimonio">R$ 0,00</div></div>
              <div class="card"><div class="card-label">Saldo</div><div class="card-value" id="vSaldo">R$ 0,00</div></div>
            </div>
            <div class="obj-grid" id="objGrid" style="grid-template-columns:repeat(3,1fr);margin-bottom:0"></div>
            <div class="reserva-box">
              <div class="reserva-head"><span class="reserva-icon">üõ°Ô∏è</span><span class="reserva-title">Reserva</span></div>
              <div class="reserva-val" id="vReserva">R$ 0,00</div>
              <div class="reserva-sub">Acumulado</div>
            </div>
          </div>
          <div class="chart-box"><div class="chart-title">üìÖ Gastos Di√°rios</div><div class="chart-wrap"><canvas id="chartDiario"></canvas></div></div>
          <div class="charts-2col">
            <div class="chart-box"><div class="chart-title">üè∑Ô∏è Categorias</div><div class="chart-wrap"><canvas id="chartCat"></canvas></div></div>
            <div class="chart-box"><div class="chart-title">üí≥ Faturas</div><div class="chart-wrap"><canvas id="chartFat"></canvas></div></div>
          </div>
          <div class="cartoes-grid" id="cartoesGrid"></div>
        </div>
      </section>
      
      <section class="tab" id="tab-add">
        <div class="container">
          <div class="add-wrap">
            <div class="form-box" id="boxLanc">
              <div class="form-head" onclick="toggleBox('boxLanc')">
                <span class="form-head-icon">‚ûï</span>
                <span class="form-head-title">Novo Lan√ßamento</span>
                <span class="form-head-arrow">‚ñº</span>
              </div>
              <div class="form-body">
                <form id="formLanc" onsubmit="salvarLanc(event)">
                  <div class="form-row">
                    <div class="form-group"><label class="form-label">Data</label><input type="date" class="form-input" id="fData" required></div>
                    <div class="form-group"><label class="form-label">Tipo</label><select class="form-select" id="fTipo"><option value="Entrada">Entrada</option><option value="Sa√≠da">Sa√≠da</option></select></div>
                  </div>
                  <div class="form-row">
                    <div class="form-group"><label class="form-label">Categoria</label><select class="form-select" id="fCat" onchange="onCatChange()"></select></div>
                    <div class="form-group" id="subGrp" style="display:none"><label class="form-label" id="subLabel">Destino</label><select class="form-select" id="fSub"></select></div>
                  </div>
                  <div class="form-row">
                    <div class="form-group"><label class="form-label">Valor</label><input type="number" class="form-input" id="fValor" step="0.01" min="0" required></div>
                    <div class="form-group"><label class="form-label">Descri√ß√£o</label><input type="text" class="form-input" id="fDesc" placeholder="Opcional"></div>
                  </div>
                  <div class="form-group"><label class="form-label">Pagamento</label><select class="form-select" id="fPag" onchange="toggleCredit()"><option value="PIX">PIX</option><option value="Dinheiro">Dinheiro</option><option value="D√©bito">D√©bito</option><option value="Cr√©dito">Cr√©dito</option></select></div>
                  <div class="credit-fields" id="creditFields">
                    <div class="form-row">
                      <div class="form-group"><label class="form-label">Cart√£o</label><select class="form-select" id="fCartao"></select></div>
                      <div class="form-group"><label class="form-label">Parcelas</label><input type="number" class="form-input" id="fParc" value="1" min="1" max="48"></div>
                    </div>
                  </div>
                  <button type="submit" class="btn" id="btnLanc">Salvar</button>
                </form>
              </div>
            </div>
            
            <div class="form-box" id="boxContas">
              <div class="form-head" onclick="toggleBox('boxContas')">
                <span class="form-head-icon">üìã</span>
                <span class="form-head-title">Contas do M√™s</span>
                <span class="form-head-badge" id="contasBadge">0</span>
                <span class="form-head-arrow">‚ñº</span>
              </div>
              <div class="form-body" id="contasList"></div>
            </div>
            
            <div class="form-box" id="boxNovoCartao">
              <div class="form-head" onclick="toggleBox('boxNovoCartao')">
                <span class="form-head-icon">üí≥</span>
                <span class="form-head-title">Novo Cart√£o</span>
                <span class="form-head-arrow">‚ñº</span>
              </div>
              <div class="form-body">
                <form id="formCartao" onsubmit="salvarCartao(event)">
                  <div class="form-row">
                    <div class="form-group"><label class="form-label">Nome</label><input type="text" class="form-input" id="cartNome" placeholder="Ex: Nubank" required></div>
                    <div class="form-group"><label class="form-label">Limite</label><input type="number" class="form-input" id="cartLimite" step="0.01" required></div>
                  </div>
                  <div class="form-row">
                    <div class="form-group"><label class="form-label">Fechamento</label><input type="number" class="form-input" id="cartFechamento" min="1" max="31" value="1" required></div>
                    <div class="form-group"><label class="form-label">Vencimento</label><input type="number" class="form-input" id="cartVencimento" min="1" max="31" value="10" required></div>
                  </div>
                  <button type="submit" class="btn" id="btnCartao">Adicionar</button>
                </form>
              </div>
            </div>
            
            <div style="display:flex;flex-direction:column;gap:16px">
              <div class="form-box" id="boxNovaConta">
                <div class="form-head" onclick="toggleBox('boxNovaConta')">
                  <span class="form-head-icon">üìÖ</span>
                  <span class="form-head-title">Nova Conta Fixa</span>
                  <span class="form-head-arrow">‚ñº</span>
                </div>
                <div class="form-body">
                  <form id="formConta" onsubmit="salvarConta(event)">
                    <div class="form-row">
                      <div class="form-group"><label class="form-label">Nome</label><input type="text" class="form-input" id="cNome" required></div>
                      <div class="form-group"><label class="form-label">Valor</label><input type="number" class="form-input" id="cValor" step="0.01" required></div>
                    </div>
                    <div class="form-group"><label class="form-label">Dia Vencimento</label><input type="number" class="form-input" id="cDia" min="1" max="31" required></div>
                    <button type="submit" class="btn" id="btnConta">Adicionar</button>
                  </form>
                </div>
              </div>
              
              <div class="form-box" id="boxNovoObj">
                <div class="form-head" onclick="toggleBox('boxNovoObj')">
                  <span class="form-head-icon">üéØ</span>
                  <span class="form-head-title">Novo Objetivo</span>
                  <span class="form-head-arrow">‚ñº</span>
                </div>
                <div class="form-body">
                  <form id="formObj" onsubmit="salvarObj(event)">
                    <div class="form-row">
                      <div class="form-group"><label class="form-label">Nome</label><input type="text" class="form-input" id="oNome" required></div>
                      <div class="form-group"><label class="form-label">Meta</label><input type="number" class="form-input" id="oMeta" step="0.01" required></div>
                    </div>
                    <button type="submit" class="btn" id="btnObj">Adicionar</button>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
      
      <section class="tab" id="tab-hist">
        <div class="container">
          <div class="section-title">üìã Hist√≥rico do M√™s</div>
          <div class="hist-list" id="histList"></div>
        </div>
      </section>
    </main>
    
    <nav class="nav">
      <button class="nav-btn active" data-tab="tab-home" onclick="switchTab('tab-home')"><span class="ico">üìä</span><span>In√≠cio</span></button>
      <button class="nav-btn" data-tab="tab-add" onclick="switchTab('tab-add')"><span class="ico">‚ûï</span><span>Adicionar</span></button>
      <button class="nav-btn" data-tab="tab-hist" onclick="switchTab('tab-hist')"><span class="ico">üìã</span><span>Hist√≥rico</span></button>
    </nav>
  </div>

<script>
var API_URL = 'https://script.google.com/macros/s/AKfycbz-Z2vw2ciagjwx7deLfXlRgQOfc0Bwjfa0W1hsRR3UuXTb83puPsdksnelFJsh9Ohw/exec';
var data={historico:[],cartoes:[],categorias:[],contasFixas:[],objetivos:[],mesesDisponiveis:[]};
var mesFiltro='atual';
var charts={};
var objCharts={};

async function apiCall(action, params={}){
  try{
    var url=API_URL+'?action='+action;
    for(var k in params) url+='&'+k+'='+encodeURIComponent(typeof params[k]==='object'?JSON.stringify(params[k]):params[k]);
    var res=await fetch(url);
    return await res.json();
  }catch(e){console.error('API Error:',e);return {success:false,message:'Erro de conex√£o'};}
}

async function apiPost(action, payload){
  try{
    var res=await fetch(API_URL,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:'action='+action+'&data='+encodeURIComponent(JSON.stringify(payload))});
    return await res.json();
  }catch(e){console.error('API Error:',e);return {success:false,message:'Erro de conex√£o'};}
}

(function(){
  var t=localStorage.getItem('theme');if(t==='dark')document.documentElement.setAttribute('data-theme','dark');
  var m=localStorage.getItem('mes');if(m)mesFiltro=m;
  document.addEventListener('DOMContentLoaded',function(){updateThemeBtn();document.getElementById('fData').value=new Date().toISOString().split('T')[0];restoreBoxes();carregarDados();});
})();

function hideSplash(){document.getElementById('splash').classList.add('hide')}
function toggleTheme(){var d=document.documentElement;var n=d.getAttribute('data-theme')==='dark'?'light':'dark';d.setAttribute('data-theme',n==='dark'?'dark':'');localStorage.setItem('theme',n);updateThemeBtn();if(Object.keys(charts).length)atualizarGraficos();}
function updateThemeBtn(){document.getElementById('themeBtn').textContent=document.documentElement.getAttribute('data-theme')==='dark'?'‚òÄÔ∏è':'üåô'}
function toggleBox(id){var b=document.getElementById(id);if(b){b.classList.toggle('closed');localStorage.setItem('box_'+id,b.classList.contains('closed')?'1':'0')}}
function restoreBoxes(){['boxContas','boxNovaConta','boxNovoObj','boxNovoCartao','boxLanc'].forEach(function(id){var s=localStorage.getItem('box_'+id);var b=document.getElementById(id);if(b&&s==='1')b.classList.add('closed');else if(b&&s==='0')b.classList.remove('closed');});}
function switchTab(id){document.querySelectorAll('.tab').forEach(function(t){t.classList.remove('active')});document.querySelectorAll('.nav-btn').forEach(function(n){n.classList.remove('active')});document.getElementById(id).classList.add('active');var btn=document.querySelector('.nav-btn[data-tab="'+id+'"]');if(btn)btn.classList.add('active');localStorage.setItem('tab',id);}
async function carregarDados(){var r=await apiCall('getDashboardData');if(r&&!r.error){data=r;atualizarTudo()}hideSplash();}
function atualizarTudo(){try{atualizarFiltroMeses()}catch(e){console.error(e)}try{atualizarCategorias()}catch(e){console.error(e)}try{atualizarSelectCartoes()}catch(e){console.error(e)}try{atualizarResumo()}catch(e){console.error(e)}try{atualizarObjetivos()}catch(e){console.error(e)}try{atualizarGraficos()}catch(e){console.error(e)}try{atualizarContasFixas()}catch(e){console.error(e)}try{atualizarHistorico()}catch(e){console.error(e)}try{verificarVencidas()}catch(e){console.error(e)}}

function parseData(d){if(!d)return null;if(d instanceof Date)return d;if(typeof d==='string'){if(d.includes('-')){var p=d.split('-');return new Date(+p[0],+p[1]-1,+p[2]||1)}if(d.includes('/')){var p=d.split('/');return new Date(+p[2],+p[1]-1,+p[0])}}return null;}
function fmtData(d){var dt=parseData(d);if(!dt)return'';return String(dt.getDate()).padStart(2,'0')+'/'+String(dt.getMonth()+1).padStart(2,'0')}
function getMesAno(d){var dt=parseData(d);if(!dt)return null;return dt.getFullYear()+'-'+String(dt.getMonth()+1).padStart(2,'0')}
function fmtMoeda(v){return'R$ '+(v||0).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2})}
function fmtCurto(v){if(Math.abs(v)>=1000)return'R$'+(v/1000).toFixed(1)+'k';return'R$'+(v||0).toFixed(0)}
function norm(s){return String(s||'').trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'')}
function getMesFiltrado(){if(mesFiltro==='atual'){var h=new Date();return h.getFullYear()+'-'+String(h.getMonth()+1).padStart(2,'0')}return mesFiltro;}
function getMesCurto(m){return['','Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'][m]||''}

function getCartaoInfo(nomeCartao){var cartoes=data.cartoes||[];for(var i=0;i<cartoes.length;i++){if(norm(cartoes[i].nome)===norm(nomeCartao))return cartoes[i];}return {diaFechamento:1,diaVencimento:10};}
function calcMesFatura(dataCompra, nomeCartao){var dt=parseData(dataCompra);if(!dt)return null;var cartao=getCartaoInfo(nomeCartao);var diaCompra=dt.getDate();var mesCompra=dt.getMonth();var anoCompra=dt.getFullYear();var diaFechamento=cartao.diaFechamento||1;if(diaCompra>diaFechamento){mesCompra++;if(mesCompra>11){mesCompra=0;anoCompra++;}}return anoCompra+'-'+String(mesCompra+1).padStart(2,'0');}
function calcParcelas(item){var res=[];var dt=parseData(item.data);if(!dt)return res;var vp=item.valor/(item.parcelas||1);var tot=item.parcelas||1;var mesBase=calcMesFatura(item.data,item.cartao);if(!mesBase)mesBase=getMesAno(item.data);var parts=mesBase.split('-');var ano=parseInt(parts[0]);var mes=parseInt(parts[1])-1;for(var i=0;i<tot;i++){var mp=new Date(ano,mes+i,1);res.push({mes:mp.getFullYear()+'-'+String(mp.getMonth()+1).padStart(2,'0'),valor:vp,parcela:i+1});}return res;}

function atualizarFiltroMeses(){var sel=document.getElementById('monthFilter');var ms=data.mesesDisponiveis||[];sel.innerHTML='<option value="atual">M√™s Atual</option>';ms.forEach(function(m){var p=m.split('-');var opt=document.createElement('option');opt.value=m;opt.textContent=getMesCurto(+p[1])+'/'+p[0];if(m===mesFiltro)opt.selected=true;sel.appendChild(opt);});}
function filtrarMes(){mesFiltro=document.getElementById('monthFilter').value;localStorage.setItem('mes',mesFiltro);atualizarResumo();atualizarObjetivos();atualizarGraficos();atualizarHistorico();}
function verificarVencidas(){var box=document.getElementById('alertBox');var contas=data.contasFixas||[];var hoje=new Date().getDate();var venc=contas.filter(function(c){return!c.pago&&c.diaVencimento<hoje});if(!venc.length){box.classList.remove('show');return}var tot=venc.reduce(function(s,c){return s+c.valor},0);document.getElementById('alertTitle').textContent=venc.length+' conta'+(venc.length>1?'s':'')+' vencida'+(venc.length>1?'s':'');document.getElementById('alertDetail').textContent='Total: '+fmtMoeda(tot);box.classList.add('show');}

function atualizarResumo(){var mes=getMesFiltrado();var hist=data.historico||[];var patrim=0,reserva=0,objAcum=0,entAcum=0,saiAcum=0,entMes=0,saiMes=0;hist.forEach(function(it){var tipo=norm(it.tipo);var cat=norm(it.categoria);var fp=norm(it.formaPagamento);var mesIt=getMesAno(it.data);if(!mesIt)return;var isRes=(cat==='reserva de emergencia'||cat==='reserva');var isObj=cat.indexOf('objetivo:')===0;var isAloc=isRes||isObj;var isCred=(fp==='credito');if(isCred&&tipo==='saida'){if(it.parcelas>1){calcParcelas(it).forEach(function(p){if(p.mes<=mes){patrim-=p.valor;if(!isAloc)saiAcum+=p.valor}if(p.mes===mes&&!isAloc)saiMes+=p.valor;});}else{var mesFat=calcMesFatura(it.data,it.cartao);if(mesFat&&mesFat<=mes){patrim-=it.valor;if(!isAloc)saiAcum+=it.valor}if(mesFat===mes&&!isAloc)saiMes+=it.valor;}}else{var val=it.valor;if(mesIt<=mes){if(tipo==='entrada'){patrim+=val;if(!isAloc)entAcum+=val;if(isRes)reserva+=val;if(isObj)objAcum+=val}else if(tipo==='saida'){patrim-=val;if(!isAloc)saiAcum+=val;if(isRes)reserva-=val;if(isObj)objAcum-=val}}if(mesIt===mes&&!isAloc){if(tipo==='entrada')entMes+=val;else if(tipo==='saida')saiMes+=val;}}});var saldo=entAcum-saiAcum-Math.max(0,reserva)-Math.max(0,objAcum);document.getElementById('vEntradas').textContent=fmtMoeda(entMes);document.getElementById('vSaidas').textContent=fmtMoeda(saiMes);document.getElementById('vPatrimonio').textContent=fmtMoeda(patrim);document.getElementById('vSaldo').textContent=fmtMoeda(saldo);document.getElementById('vReserva').textContent=fmtMoeda(Math.max(0,reserva));var el=document.getElementById('vSaldo');el.classList.remove('green','red');if(saldo>0)el.classList.add('green');else if(saldo<0)el.classList.add('red');}

function atualizarObjetivos(){var c=document.getElementById('objGrid');var objs=data.objetivos||[];var hist=data.historico||[];var mes=getMesFiltrado();Object.keys(objCharts).forEach(function(k){if(objCharts[k])objCharts[k].destroy()});objCharts={};if(!objs.length){c.innerHTML='<div class="obj-card"><div class="empty"><div class="empty-icon">üéØ</div><p>Sem objetivos</p></div></div>';return}var html='';objs.forEach(function(o,i){html+='<div class="obj-card"><button class="obj-del" onclick="excluirObj(\''+o.nome.replace(/'/g,"\\'")+'\')" title="Excluir">√ó</button><div class="obj-chart"><canvas id="objC'+i+'"></canvas><div class="obj-val" id="objV'+i+'">R$0</div></div><div class="obj-name">'+o.nome+'</div></div>';});c.innerHTML=html;objs.forEach(function(o,i){var val=0;var nNorm=norm(o.nome);var p1='objetivo: '+nNorm;var p2='objetivo:'+nNorm;hist.forEach(function(h){var mIt=getMesAno(h.data);if(!mIt||mIt>mes)return;var cN=norm(h.categoria);var tN=norm(h.tipo);if(cN===p1||cN===p2){if(tN==='entrada')val+=h.valor;else if(tN==='saida')val-=h.valor;}});val=Math.max(0,val);var pct=o.meta>0?Math.min(val/o.meta*100,100):0;document.getElementById('objV'+i).textContent=fmtCurto(val);var ctx=document.getElementById('objC'+i).getContext('2d');var dk=document.documentElement.getAttribute('data-theme')==='dark';objCharts['o'+i]=new Chart(ctx,{type:'doughnut',data:{datasets:[{data:[pct,100-pct],backgroundColor:['rgba(74,155,110,.9)',dk?'rgba(64,64,64,.5)':'rgba(240,238,235,.8)'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:true,cutout:'70%',plugins:{legend:{display:false},tooltip:{enabled:false}}}});});}

function atualizarGraficos(){graficosDiarios();graficosCategorias();graficosFaturas();atualizarCartoesGrid()}
function graficosDiarios(){var ctx=document.getElementById('chartDiario').getContext('2d');var mes=getMesFiltrado();var hist=data.historico||[];var p=mes.split('-');var ano=+p[0],m=+p[1];var dias=new Date(ano,m,0).getDate();var gastos=[];for(var i=0;i<dias;i++)gastos.push(0);hist.forEach(function(it){if(norm(it.tipo)!=='saida')return;var fp=norm(it.formaPagamento);var dt=parseData(it.data);if(!dt)return;if(fp==='credito'){if(it.parcelas>1){calcParcelas(it).forEach(function(pc){if(pc.mes===mes)gastos[dt.getDate()-1]+=pc.valor;});}else{var mesFat=calcMesFatura(it.data,it.cartao);if(mesFat===mes)gastos[dt.getDate()-1]+=it.valor;}}else{if(getMesAno(it.data)===mes)gastos[dt.getDate()-1]+=it.valor;}});var labels=[];for(var i=1;i<=dias;i++)labels.push(i);if(charts.diario)charts.diario.destroy();charts.diario=new Chart(ctx,{type:'line',data:{labels:labels,datasets:[{data:gastos,borderColor:'#C45C4D',backgroundColor:'rgba(196,92,77,.1)',fill:true,tension:.3,pointRadius:0,borderWidth:2}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{grid:{display:false},ticks:{font:{size:11},maxRotation:0}},y:{grid:{color:'rgba(0,0,0,.05)'},ticks:{font:{size:11},callback:function(v){return fmtCurto(v)}},beginAtZero:true}}}});}
function graficosCategorias(){var ctx=document.getElementById('chartCat').getContext('2d');var mes=getMesFiltrado();var hist=data.historico||[];var gastos={};hist.forEach(function(it){if(norm(it.tipo)!=='saida')return;var cat=it.categoria||'Outros';var fp=norm(it.formaPagamento);if(fp==='credito'){if(it.parcelas>1){calcParcelas(it).forEach(function(pc){if(pc.mes===mes)gastos[cat]=(gastos[cat]||0)+pc.valor});}else{var mesFat=calcMesFatura(it.data,it.cartao);if(mesFat===mes)gastos[cat]=(gastos[cat]||0)+it.valor;}}else{if(getMesAno(it.data)===mes)gastos[cat]=(gastos[cat]||0)+it.valor;}});var ent=Object.entries(gastos).sort(function(a,b){return b[1]-a[1]}).slice(0,6);var labels=ent.map(function(e){return e[0].substring(0,12)});var vals=ent.map(function(e){return e[1]});if(charts.cat)charts.cat.destroy();charts.cat=new Chart(ctx,{type:'bar',data:{labels:labels,datasets:[{data:vals,backgroundColor:'#593825',borderRadius:4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{grid:{display:false},ticks:{font:{size:10},maxRotation:45,minRotation:45}},y:{grid:{color:'rgba(0,0,0,.05)'},ticks:{font:{size:11},callback:function(v){return fmtCurto(v)}},beginAtZero:true}}}});}
function graficosFaturas(){var ctx=document.getElementById('chartFat').getContext('2d');var hist=data.historico||[];var mes=getMesFiltrado();var p=mes.split('-');var anoB=+p[0],mesB=+p[1]-1;var meses=[];for(var i=0;i<6;i++){var d=new Date(anoB,mesB+i,1);meses.push(d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0'))}var carts={};(data.cartoes||[]).forEach(function(c){carts[c.nome]={};meses.forEach(function(m){carts[c.nome][m]=0})});hist.forEach(function(it){if(norm(it.tipo)!=='saida'||norm(it.formaPagamento)!=='credito'||!it.cartao)return;if(it.parcelas>1){calcParcelas(it).forEach(function(pc){if(carts[it.cartao]&&carts[it.cartao].hasOwnProperty(pc.mes))carts[it.cartao][pc.mes]+=pc.valor;});}else{var mesFat=calcMesFatura(it.data,it.cartao);if(carts[it.cartao]&&carts[it.cartao].hasOwnProperty(mesFat))carts[it.cartao][mesFat]+=it.valor;}});var labels=meses.map(function(m){return getMesCurto(+m.split('-')[1])});var datasets=[];var cores=['#593825','#7A4E3A','#8B6347','#A07855'];var idx=0;for(var c in carts){datasets.push({label:c,data:meses.map(function(m){return carts[c][m]||0}),backgroundColor:cores[idx%4],borderRadius:4});idx++}if(!datasets.length)datasets.push({label:'Sem dados',data:[0,0,0,0,0,0],backgroundColor:'rgba(89,56,37,.3)'});if(charts.fat)charts.fat.destroy();charts.fat=new Chart(ctx,{type:'bar',data:{labels:labels,datasets:datasets},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{grid:{display:false},ticks:{font:{size:11}},stacked:true},y:{grid:{color:'rgba(0,0,0,.05)'},ticks:{font:{size:11},callback:function(v){return fmtCurto(v)}},stacked:true,beginAtZero:true}}}});}
function atualizarCartoesGrid(){var c=document.getElementById('cartoesGrid');var carts=data.cartoes||[];var hist=data.historico||[];var mes=getMesFiltrado();if(!carts.length){c.innerHTML='<div class="cartao-box"><div class="empty"><div class="empty-icon">üí≥</div><p>Sem cart√µes</p></div></div>';return}var info={};carts.forEach(function(ct){info[ct.nome]={limite:ct.limite,atual:0}});hist.forEach(function(it){if(norm(it.tipo)!=='saida'||norm(it.formaPagamento)!=='credito'||!it.cartao||!info[it.cartao])return;if(it.parcelas>1){calcParcelas(it).forEach(function(pc){if(pc.mes===mes)info[it.cartao].atual+=pc.valor});}else{var mesFat=calcMesFatura(it.data,it.cartao);if(mesFat===mes)info[it.cartao].atual+=it.valor;}});function getIcon(n){var l=n.toLowerCase();if(l.indexOf('nubank')>-1)return'nubank';if(l.indexOf('inter')>-1)return'inter';if(l.indexOf('itau')>-1)return'itau';if(l.indexOf('bradesco')>-1)return'bradesco';if(l.indexOf('santander')>-1)return'santander';if(l.indexOf('c6')>-1)return'c6';return'default'}var html='';carts.forEach(function(ct){var x=info[ct.nome];var disp=Math.max(0,x.limite-x.atual);html+='<div class="cartao-box"><button class="cartao-del" onclick="excluirCartao(\''+ct.nome.replace(/'/g,"\\'")+'\')" title="Excluir">√ó</button><div class="cartao-icon '+getIcon(ct.nome)+'">üí≥</div><div class="cartao-nome">'+ct.nome+'</div><div class="cartao-fat">'+fmtMoeda(x.atual)+'</div><div class="cartao-disp">Disp: '+fmtCurto(disp)+'</div></div>';});c.innerHTML=html;}

function atualizarCategorias(){var sel=document.getElementById('fCat');sel.innerHTML='';['Investimentos','Conta Fixa'].forEach(function(c){var o=document.createElement('option');o.value=c;o.textContent=c;sel.appendChild(o)});var sep=document.createElement('option');sep.disabled=true;sep.textContent='‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ';sel.appendChild(sep);(data.categorias||[]).forEach(function(c){var cn=norm(c);if(cn.indexOf('objetivo:')===0||cn==='reserva de emergencia'||cn==='reserva'||cn==='conta fixa'||cn==='investimentos')return;var o=document.createElement('option');o.value=c;o.textContent=c;sel.appendChild(o);});onCatChange();}
function onCatChange(){var cat=document.getElementById('fCat').value;var cn=norm(cat);var subGrp=document.getElementById('subGrp');var subSel=document.getElementById('fSub');var subLbl=document.getElementById('subLabel');subSel.innerHTML='';if(cn==='investimentos'){subGrp.style.display='block';subLbl.textContent='Destino';var oR=document.createElement('option');oR.value='Reserva de Emerg√™ncia';oR.textContent='üõ°Ô∏è Reserva';subSel.appendChild(oR);(data.objetivos||[]).forEach(function(obj){var o=document.createElement('option');o.value='OBJETIVO: '+obj.nome;o.textContent='üéØ '+obj.nome;subSel.appendChild(o)});}else if(cn==='conta fixa'){subGrp.style.display='block';subLbl.textContent='Conta';var pend=(data.contasFixas||[]).filter(function(c){return!c.pago});pend.forEach(function(c){var o=document.createElement('option');o.value=c.nome;o.textContent=c.nome+' - '+fmtMoeda(c.valor);o.dataset.valor=c.valor;subSel.appendChild(o)});subSel.onchange=function(){var s=subSel.options[subSel.selectedIndex];if(s&&s.dataset.valor)document.getElementById('fValor').value=s.dataset.valor};if(subSel.options.length)subSel.onchange();}else{subGrp.style.display='none';}}
function atualizarSelectCartoes(){var sel=document.getElementById('fCartao');sel.innerHTML='';(data.cartoes||[]).forEach(function(c){var o=document.createElement('option');o.value=c.nome;o.textContent=c.nome;sel.appendChild(o)});}
function toggleCredit(){document.getElementById('creditFields').classList.toggle('show',document.getElementById('fPag').value==='Cr√©dito')}

function atualizarContasFixas(){var c=document.getElementById('contasList');var contas=data.contasFixas||[];var pend=contas.filter(function(x){return!x.pago});document.getElementById('contasBadge').textContent=pend.length;if(!contas.length){c.innerHTML='<div class="empty"><div class="empty-icon">üìã</div><p>Sem contas</p></div>';return}var sorted=contas.slice().sort(function(a,b){return a.diaVencimento-b.diaVencimento});var html='';sorted.forEach(function(ct){html+='<div class="conta-item '+(ct.pago?'pago':'')+'"><input type="checkbox" class="conta-check" '+(ct.pago?'checked':'')+' onchange="toggleConta(\''+ct.nome.replace(/'/g,"\\'")+'\',this.checked)"><div class="conta-info"><div class="conta-nome">'+ct.nome+'</div><div class="conta-detalhe">Dia '+ct.diaVencimento+'</div></div><div class="conta-valor">'+fmtMoeda(ct.valor)+'</div><button class="conta-del" onclick="excluirContaFixa(\''+ct.nome.replace(/'/g,"\\'")+'\')">üóëÔ∏è</button></div>';});c.innerHTML=html;}
async function toggleConta(nome,pago){var r=await apiPost('marcarContaFixaPaga',{nome:nome,pago:pago});if(r.success){toast(pago?'Pago!':'Desmarcado','ok');carregarDados()}else toast(r.message,'err');}

function atualizarHistorico(){var c=document.getElementById('histList');var hist=data.historico||[];var mes=getMesFiltrado();var filt=hist.filter(function(i){return getMesAno(i.data)===mes}).sort(function(a,b){return parseData(b.data)-parseData(a.data)});if(!filt.length){c.innerHTML='<div class="empty"><div class="empty-icon">üìã</div><p>Sem lan√ßamentos</p></div>';return}var html='';filt.forEach(function(it){var isIn=norm(it.tipo)==='entrada';var vp=it.valor/(it.parcelas||1);var parc=it.parcelas>1;html+='<div class="hist-item"><div class="hist-icon '+(isIn?'in':'out')+'">'+(isIn?'üìà':'üìâ')+'</div><div class="hist-info"><div class="hist-desc">'+(it.descricao||it.categoria||'Sem desc')+(parc?'<span class="parc-badge">'+it.parcelaAtual+'/'+it.parcelas+'</span>':'')+'</div><div class="hist-meta">'+fmtData(it.data)+' ‚Ä¢ '+(it.categoria||'')+'</div></div><div class="hist-right"><div class="hist-val '+(isIn?'in':'out')+'">'+(isIn?'+':'-')+fmtMoeda(parc?vp:it.valor)+'</div><button class="hist-del" onclick="excluir('+it.rowIndex+')">üóëÔ∏è</button></div></div>';});c.innerHTML=html;}

async function excluir(row){if(!confirm('Excluir este lan√ßamento?'))return;var r=await apiPost('removerLancamento',{rowIndex:row});if(r.success){toast('Exclu√≠do!','ok');carregarDados()}else toast(r.message||'Erro','err');}
async function excluirObj(nome){if(!confirm('Excluir objetivo "'+nome+'"?'))return;var r=await apiPost('removerObjetivo',{nome:nome});if(r.success){toast('Objetivo exclu√≠do!','ok');carregarDados()}else toast(r.message||'Erro','err');}
async function excluirCartao(nome){if(!confirm('Excluir cart√£o "'+nome+'"?'))return;var r=await apiPost('removerCartao',{nome:nome});if(r.success){toast('Cart√£o exclu√≠do!','ok');carregarDados()}else toast(r.message||'Erro','err');}
async function excluirContaFixa(nome){if(!confirm('Excluir conta fixa "'+nome+'"?'))return;var r=await apiPost('removerContaFixa',{nome:nome});if(r.success){toast('Conta exclu√≠da!','ok');carregarDados()}else toast(r.message||'Erro','err');}

async function salvarLanc(e){e.preventDefault();var btn=document.getElementById('btnLanc');btn.disabled=true;btn.innerHTML='<span class="btn-spin"></span>Salvando...';var fp=document.getElementById('fPag').value;var isCred=fp==='Cr√©dito';var cat=document.getElementById('fCat').value;var cn=norm(cat);var desc=document.getElementById('fDesc').value;if(cn==='investimentos'||cn==='conta fixa'){var sub=document.getElementById('fSub');if(sub&&sub.value){cat=sub.value;if(!desc)desc=sub.options[sub.selectedIndex].textContent.split(' - ')[0].replace(/^[üõ°Ô∏èüéØ]\s*/,'')}}var lanc={data:document.getElementById('fData').value,tipo:document.getElementById('fTipo').value,categoria:cat,valor:parseFloat(document.getElementById('fValor').value)||0,descricao:desc||cat,formaPagamento:fp,cartao:isCred?document.getElementById('fCartao').value:'',parcelas:isCred?parseInt(document.getElementById('fParc').value)||1:1,parcelaAtual:1};var r=await apiPost('adicionarLancamento',lanc);btn.disabled=false;btn.innerHTML='Salvar';if(r.success){toast('Salvo!','ok');document.getElementById('formLanc').reset();document.getElementById('fData').value=new Date().toISOString().split('T')[0];toggleCredit();onCatChange();carregarDados();}else toast(r.message||'Erro','err');}
async function salvarConta(e){e.preventDefault();var btn=document.getElementById('btnConta');btn.disabled=true;btn.innerHTML='<span class="btn-spin"></span>';var ct={nome:document.getElementById('cNome').value,valor:parseFloat(document.getElementById('cValor').value)||0,diaVencimento:parseInt(document.getElementById('cDia').value)||1};var r=await apiPost('adicionarContaFixa',ct);btn.disabled=false;btn.innerHTML='Adicionar';if(r.success){toast('Adicionado!','ok');document.getElementById('formConta').reset();carregarDados()}else toast(r.message||'Erro','err');}
async function salvarObj(e){e.preventDefault();var btn=document.getElementById('btnObj');btn.disabled=true;btn.innerHTML='<span class="btn-spin"></span>';var obj={nome:document.getElementById('oNome').value,meta:parseFloat(document.getElementById('oMeta').value)||0};var r=await apiPost('adicionarObjetivo',obj);btn.disabled=false;btn.innerHTML='Adicionar';if(r.success){toast('Adicionado!','ok');document.getElementById('formObj').reset();carregarDados()}else toast(r.message||'Erro','err');}
async function salvarCartao(e){e.preventDefault();var btn=document.getElementById('btnCartao');btn.disabled=true;btn.innerHTML='<span class="btn-spin"></span>';var cart={nome:document.getElementById('cartNome').value,limite:parseFloat(document.getElementById('cartLimite').value)||0,diaFechamento:parseInt(document.getElementById('cartFechamento').value)||1,diaVencimento:parseInt(document.getElementById('cartVencimento').value)||10};var r=await apiPost('adicionarCartao',cart);btn.disabled=false;btn.innerHTML='Adicionar';if(r.success){toast('Cart√£o adicionado!','ok');document.getElementById('formCartao').reset();carregarDados()}else toast(r.message||'Erro','err');}
function toast(msg,type){var w=document.getElementById('toastWrap');var t=document.createElement('div');t.className='toast '+(type||'');t.textContent=msg;w.appendChild(t);setTimeout(function(){t.remove()},3000);}
</script>
<script>if("serviceWorker" in navigator){window.addEventListener("load",()=>{navigator.serviceWorker.register("/service-worker.js").catch(console.error)})}</script>
</body>
</html>
